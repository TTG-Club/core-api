databaseChangeLog:
  - changeSet:
      id: 26-03-pack-creature-defenses-jsonb
      author: Magistrus
      preConditions:
        - onFail: HALT
        - tableExists:
            tableName: bestiary
        - or:
            - columnExists: { tableName: bestiary, columnName: vulnerabilities }
            - columnExists: { tableName: bestiary, columnName: resistance }
            - columnExists: { tableName: bestiary, columnName: immunityToDamage }
            - columnExists: { tableName: bestiary, columnName: immunityToCondition }
      changes:
        # 1) Добавляем новую целевую колонку
        - addColumn:
            tableName: bestiary
            columns:
              - column:
                  name: defenses
                  type: jsonb
                  defaultValue: '{}'

        # 2) Переносим данные. Пустые строки -> NULL, пустые массивы сохраняем как [].
        - sql:
            splitStatements: false
            sql: |
              UPDATE bestiary
              SET defenses = jsonb_strip_nulls(
                jsonb_build_object(
                  'vulnerabilities',
                    jsonb_strip_nulls(
                      jsonb_build_object(
                        'values', COALESCE(vulnerabilities, '[]'::jsonb),
                        'text', NULLIF(BTRIM(vulnerabilities_text), '')
                      )
                    ),
                  'resistances',
                    jsonb_strip_nulls(
                      jsonb_build_object(
                        'values', COALESCE(resistance, '[]'::jsonb),
                        'text', NULLIF(BTRIM(resistance_text), '')
                      )
                    ),
                  'immunities',
                    jsonb_strip_nulls(
                      jsonb_build_object(
                        'damage',    COALESCE(immunityToDamage, '[]'::jsonb),
                        'condition', COALESCE(immunityToCondition, '[]'::jsonb),
                        'text',      NULLIF(BTRIM(immunity_text), '')
                      )
                    )
                )
              );

        # 3) (опционально) удаляем старые колонки после успешного переноса
        # Закомментируйте, если хотите выполнить удаление отдельным changeSet'ом
        - dropColumn: { tableName: bestiary, columnName: vulnerabilities }
        - dropColumn: { tableName: bestiary, columnName: vulnerabilities_text }
        - dropColumn: { tableName: bestiary, columnName: resistance }
        - dropColumn: { tableName: bestiary, columnName: resistance_text }
        - dropColumn: { tableName: bestiary, columnName: immunityToDamage }
        - dropColumn: { tableName: bestiary, columnName: immunityToCondition }
        - dropColumn: { tableName: bestiary, columnName: immunity_text }

      rollback:
        # 1) Восстанавливаем старые колонки
        - addColumn:
            tableName: bestiary
            columns:
              - column: { name: vulnerabilities,        type: jsonb, defaultValue: '[]' }
              - column: { name: vulnerabilities_text,    type: TEXT }
              - column: { name: resistance,             type: jsonb, defaultValue: '[]' }
              - column: { name: resistance_text,         type: TEXT }
              - column: { name: immunityToDamage,       type: jsonb, defaultValue: '[]' }
              - column: { name: immunityToCondition,    type: jsonb, defaultValue: '[]' }
              - column: { name: immunity_text,           type: TEXT }

        # 2) Извлекаем значения обратно из defenses
        - sql:
            splitStatements: false
            sql: |
              UPDATE bestiary
              SET vulnerabilities        = COALESCE(defenses->'vulnerabilities'->'values', '[]'::jsonb),
                  vulnerabilities_text    = NULLIF(BTRIM((defenses->'vulnerabilities'->>'text')), ''),
                  resistance             = COALESCE(defenses->'resistances'->'values', '[]'::jsonb),
                  resistance_text         = NULLIF(BTRIM((defenses->'resistances'->>'text')), ''),
                  immunityToDamage       = COALESCE(defenses->'immunities'->'damage', '[]'::jsonb),
                  immunityToCondition    = COALESCE(defenses->'immunities'->'condition', '[]'::jsonb),
                  immunity_text           = NULLIF(BTRIM((defenses->'immunities'->>'text')), '');

        # 3) Удаляем defenses
        - dropColumn:
            tableName: bestiary
            columnName: defenses
